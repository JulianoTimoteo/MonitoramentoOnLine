<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Monitoramento Operacional - Usina Pitangueiras v7.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --color-primary: #047857; /* Verde */
            --color-secondary: #1f2937;
            --color-background: #f9fafb;
            --color-fertirrigacao: #2563eb; /* Azul */
            --color-limites: #d97706; /* Âmbar */
            --color-cadastro: #7c3aed; /* Roxo */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); }
        
        .hidden { display: none !important; }
        #login-screen, #splashScreen, #app-container { display: none; }
        #login-screen.active { display: flex; }
        #splashScreen.active { display: flex; opacity: 1; transition: opacity 1.5s ease-out; }
        #app-container.active { display: block; opacity: 1; transition: opacity 0.5s ease-in-out; }

        #splash-logo { transition: all 1s ease-in-out; }
        #splash-slogan { transition: opacity 1s ease-in 0.5s; }
        .header-logo { transition: all 1.5s ease-in-out; }
        .header-logo-start { height: 150px !important; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 51; }

        .metric-card { 
            background-color: white; 
            border-radius: 0.75rem; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            position: relative; 
            overflow: hidden; 
        }
        .metric-card:hover { transform: translateY(-5px); }

        .tab-button { transition: all 0.2s ease-in-out; border-bottom: 4px solid transparent; padding: 1rem 0.25rem; font-weight: 600; color: #6b7280; }
        .tab-button.active { font-weight: 700; }
        #tabs-container.implementos .tab-button[data-tab="implementos"].active { border-color: var(--color-primary); color: var(--color-primary); }
        #tabs-container.fertirrigacao .tab-button[data-tab="fertirrigacao"].active { border-color: var(--color-fertirrigacao); color: var(--color-fertirrigacao); }
        #tabs-container.limites .tab-button[data-tab="limites"].active { border-color: var(--color-limites); color: var(--color-limites); }
        #tabs-container.cadastro .tab-button[data-tab="cadastro"].active { border-color: var(--color-cadastro); color: var(--color-cadastro); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .data-label { text-transform: uppercase; font-size: 0.875rem; color: #4b5563; }
        .data-value { font-size: 2.25rem; font-weight: 800; }

        .table-header { background-color: var(--color-primary); color: white; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; }
        .table-row:nth-child(even) { background-color: #f3f4f6; }

        .status-produtivo { border-color: #10b981 !important; color: #059669 !important; }
        .status-parado { border-color: #f59e0b !important; color: #d97706 !important; }
        .status-manutencao { border-color: #ef4444 !important; color: #dc2626 !important; }
        .status-erro { border-color: #6b7280 !important; color: #4b5563 !important; }

        .modal-content { transition: opacity 0.3s ease-out, transform 0.3s ease-out; transform: scale(0.95); opacity: 0; }
        .modal-container:not(.hidden) .modal-content { transform: scale(1); opacity: 1; }
        .admin-sub-tab { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; }
        .admin-sub-tab.active { background-color: var(--color-cadastro); color: white; }

        /* Estilos para sub-abas de Fertirrigação */
        .fert-sub-tab { cursor: pointer; padding: 0.5rem 1rem; border-radius: 9999px; transition: all 0.2s; border: 1px solid #d1d5db; color: #4b5563; }
        .fert-sub-tab.active { background-color: var(--color-fertirrigacao); color: white; border-color: var(--color-fertirrigacao); }
        .fert-sub-content { display: none; animation: fadeIn 0.5s; }
        .fert-sub-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .zoom-hover-card {
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 10;
            position: relative;
        }
        .zoom-hover-card:hover {
            transform: scale(1.5);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 20;
        }

        #vazao-table th {
            padding: 1rem 0.75rem;
            border-bottom: 2px solid rgb(55 65 81);
            color: rgb(156 163 175);
            font-weight: 600;
            text-align: left;
            font-size: 1rem;
            text-transform: uppercase;
        }
        #vazao-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid rgb(75 85 99);
            color: rgb(209 213 219);
            font-size: 1.125rem;
        }
        #vazao-table tr:last-child td {
            border-bottom: none;
        }


        @property --angle {
          syntax: '<angle>';
          initial-value: 0deg;
          inherits: false;
        }

        @keyframes rotate {
          to { --angle: 360deg; }
        }

        .animated-border {
            --animation-color: transparent; position: relative; overflow: hidden; border-radius: 0.75rem;
        }
        .animated-border::before {
            content: ''; position: absolute; z-index: 0; inset: -3px; border-radius: inherit;
            background: conic-gradient(from var(--angle), var(--animation-color), transparent 30%, transparent);
            animation: rotate 8s linear infinite;
        }
        .animated-border::after {
            content: ''; position: absolute; z-index: 1; inset: 2px; border-radius: 0.6rem; background: var(--card-bg, white);
        }
        .card-content-wrapper { position: relative; z-index: 2; padding: 1.5rem; }
        .login-card-border-top { border-top: 8px solid var(--animation-color, var(--color-primary)); padding: 0; }
        .login-card-border-top .card-content-wrapper { padding: 2rem; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="min-h-screen items-center justify-center bg-gray-100 active p-4"></div>
    <div id="splashScreen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50"></div>
    <div id="app-container" class="min-h-screen"></div>
    <div id="modal-placeholder"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, orderBy, limit, getDoc, updateDoc, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBN-jcSaOxiIg9H8Zc2MxdPoBe36g3qnV4", 
            authDomain: "monitoramento-esp32-2551e.firebaseapp.com",
            projectId: "monitoramento-esp32-2551e",
            storageBucket: "monitoramento-esp32-2551e.appspot.com",
            messagingSenderId: "1026903641131",
            appId: "1:1026903641131:web:86e847b5e600914b26ae6e"
        };
        const FIRESTORE_ROOT_PREFIX = 'artifacts/monitoramento-esp32-2551e/public/data';
        const FIRESTORE_USERS_COLLECTION_PATH = `${FIRESTORE_ROOT_PREFIX}/users`;
        const FIRESTORE_LIMITS_COLLECTION_PATH = `${FIRESTORE_ROOT_PREFIX}/operational_limits`;
        const FIRESTORE_READINGS_COLLECTION_PATH = `${FIRESTORE_ROOT_PREFIX}/leituras_esp32`;

        let app, auth, db;
        let currentUserProfile = null;
        let readingsCache = [];
        let depthChart = null;
        let productiveChart = null;
        let currentLimits = { produtivoMin: 10.0, produtivoMax: 50.0, paradoCentro: 70.0, paradoTolerancia: 5.0 };
        const CONNECTION_TIMEOUT_MS = 5 * 60 * 1000;
        
        let currentEquipmentId = null; 
        let unsubscribeLimits = () => {};
        let unsubscribeReadings = () => {};
        
        // --- VARIÁVEIS GLOBAIS PARA FERTIRRIGAÇÃO ---
        let lagoasChart = null;
        let fertirrigacaoInterval = null;
        let fertirrigacaoSubTabInterval = null;
        let lagoonsData = {};
        let totalVolumeIn = 0;
        let totalVolumeOut = 0;
        // -------------------------------------------

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-screen').innerHTML = getLoginHTML();
            document.getElementById('splashScreen').innerHTML = getSplashHTML();
            initializeAppAndAuth();
        });

        async function initializeAppAndAuth() {
            try {
                app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                setupAuthListeners();
                onAuthStateChanged(auth, user => {
                    if (user) {
                        handleUserProfile(user);
                    } else {
                        currentUserProfile = null;
                        showLoginScreen();
                    }
                });
            } catch (error) { console.error("Erro fatal na inicialização:", error); }
        }
        
        function initializeDashboard() {
            document.getElementById('logout-button')?.addEventListener('click', () => {
                unsubscribeLimits();
                unsubscribeReadings();
                controlFertirrigacaoSimulation(false);
                if (depthChart) { depthChart.destroy(); depthChart = null; }
                if (productiveChart) { productiveChart.destroy(); productiveChart = null; }
                if (lagoasChart) { lagoasChart.destroy(); lagoasChart = null; }
                signOut(auth);
            });
            document.getElementById('change-password-button')?.addEventListener('click', handlePasswordReset);
            setupTabNavigation();
            
            populateAndSetupEquipmentSelectors();

            const canManageLimits = currentUserProfile.role === 'Master' || (currentUserProfile.permissions && currentUserProfile.permissions.includes('limites'));

            if (canManageLimits) {
                document.getElementById('limits-form')?.addEventListener('submit', handleSaveLimits);
                document.getElementById('new-equipment-form')?.addEventListener('submit', handleVincularEquipamento);
            }

            if (currentUserProfile.role === 'Master') {
                document.getElementById('add-user-form')?.addEventListener('submit', handleAddUser);
                setupAdminTabs();
                loadAdminData('pendentes'); 
            }
        }
        
        async function populateAndSetupEquipmentSelectors() {
            const implementosSelect = document.getElementById('equipment-select-implementos');
            const limitesSelect = document.getElementById('equipment-select-limites');
            if (!implementosSelect || !limitesSelect) return;

            try {
                const q = query(collection(db, FIRESTORE_LIMITS_COLLECTION_PATH));
                onSnapshot(q, (snapshot) => {
                    const previouslySelectedId = currentEquipmentId; 
                    implementosSelect.innerHTML = ''; 
                    limitesSelect.innerHTML = ''; 

                    let firstEquipmentId = null;
                    let idList = [];
                    if (snapshot.empty) {
                        const noEquipMsg = '<option value="">Nenhum equipamento cadastrado</option>';
                        implementosSelect.innerHTML = noEquipMsg;
                        limitesSelect.innerHTML = noEquipMsg;
                        loadEquipmentData(null);
                        return;
                    }

                    snapshot.forEach(doc => {
                        const equipmentId = doc.id;
                        idList.push(equipmentId);
                        if (!firstEquipmentId) firstEquipmentId = equipmentId;
                        const optionHTML = `<option value="${equipmentId}">${equipmentId}</option>`;
                        implementosSelect.innerHTML += optionHTML;
                        limitesSelect.innerHTML += optionHTML;
                    });
                    
                    let idToSelect = previouslySelectedId && idList.includes(previouslySelectedId)
                        ? previouslySelectedId
                        : firstEquipmentId;

                    if (idToSelect) {
                        implementosSelect.value = idToSelect;
                        limitesSelect.value = idToSelect;
                        if (currentEquipmentId !== idToSelect) {
                            currentEquipmentId = idToSelect;
                            loadEquipmentData(idToSelect);
                        }
                    }
                });

                const handleSelectionChange = (event) => {
                    const selectedEquipmentId = event.target.value;
                    if (selectedEquipmentId) {
                        currentEquipmentId = selectedEquipmentId;
                        implementosSelect.value = selectedEquipmentId;
                        limitesSelect.value = selectedEquipmentId;
                        loadEquipmentData(selectedEquipmentId);
                    }
                };

                implementosSelect.addEventListener('change', handleSelectionChange);
                limitesSelect.addEventListener('change', handleSelectionChange);

            } catch (error) {
                console.error("Erro ao carregar equipamentos:", error);
                showMessage('Erro', 'Não foi possível carregar a lista de equipamentos.', 'error');
            }
        }

        async function loadEquipmentData(equipmentId) {
            unsubscribeLimits();
            unsubscribeReadings();
            readingsCache = [];
            
            const nameInput = document.getElementById('equipment-name');
            const macInput = document.getElementById('equipment-mac');

            if (!equipmentId) {
                if (nameInput) nameInput.value = '';
                if (macInput) macInput.value = '';
                updateDashboard([]);
                updateConfigForm(null);
                return;
            };

            const limitsRef = doc(db, FIRESTORE_LIMITS_COLLECTION_PATH, equipmentId);
            const limitsDoc = await getDoc(limitsRef);

            if (limitsDoc.exists()) {
                const data = limitsDoc.data();
                if (nameInput) nameInput.value = equipmentId;
                if (macInput) macInput.value = data.mac || '';
                
                listenToLimits(equipmentId);
                listenToReadings(equipmentId);
            }
        }
        
        async function handleVincularEquipamento(e) {
            e.preventDefault();
            const form = e.target;
            const newMac = form.elements['new-mac'].value.trim().toUpperCase();
            const newName = form.elements['new-equipment-name'].value.trim();

            if (!newMac || !newName) {
                return showMessage('Erro', 'MAC Address e Nome do Equipamento são obrigatórios.', 'error');
            }
            
            const macQuery = query(collection(db, FIRESTORE_LIMITS_COLLECTION_PATH), where("mac", "==", newMac));
            const macSnapshot = await getDocs(macQuery);
            if (!macSnapshot.empty) {
                return showMessage('Erro de Duplicidade', `O MAC Address ${newMac} já está vinculado a outro equipamento.`, 'error');
            }

            const nameRef = doc(db, FIRESTORE_LIMITS_COLLECTION_PATH, newName);
            const nameDoc = await getDoc(nameRef);
            if (nameDoc.exists()) {
                 return showMessage('Erro de Duplicidade', `O nome de equipamento "${newName}" já existe. Escolha outro.`, 'error');
            }

            try {
                const defaultLimits = {
                    mac: newMac,
                    equipamento: newName,
                    produtivoMin: 10.0,
                    produtivoMax: 50.0,
                    paradoCentro: 70.0,
                    paradoTolerancia: 5.0,
                    createdAt: serverTimestamp()
                };
                await setDoc(nameRef, defaultLimits);
                showMessage('Sucesso!', `Equipamento "${newName}" vinculado com sucesso.`, 'success');
                form.reset();
            } catch (error) {
                console.error("Erro ao vincular equipamento:", error);
                showMessage('Erro', 'Não foi possível criar o novo vínculo.', 'error');
            }
        }

        async function handleSaveLimits(e) {
            e.preventDefault();
            const originalEquipmentId = currentEquipmentId;

            if (!originalEquipmentId) {
                return showMessage('Atenção', 'Selecione um equipamento na lista antes de salvar.', 'warning');
            }

            const form = e.target;
            const newName = form.elements['equipment-name'].value.trim();

            if (!newName) {
                return showMessage('Erro', 'O nome do equipamento não pode ficar em branco.', 'error');
            }
            
            const newLimitsData = {
                produtivoMin: parseFloat(form.elements['input-produtivo-min'].value),
                produtivoMax: parseFloat(form.elements['input-produtivo-max'].value),
                paradoCentro: parseFloat(form.elements['input-parado-centro'].value),
                paradoTolerancia: parseFloat(form.elements['input-parado-tolerancia'].value),
                updatedAt: serverTimestamp()
            };
            
            if (isNaN(newLimitsData.produtivoMin) || isNaN(newLimitsData.produtivoMax) || isNaN(newLimitsData.paradoCentro) || isNaN(newLimitsData.paradoTolerancia)) {
                 return showMessage('Erro de Validação', 'Todos os campos de limites devem ser números válidos.', 'error');
            }
            if (newLimitsData.produtivoMin >= newLimitsData.produtivoMax) {
                return showMessage('Erro de Validação', 'A Profundidade Mínima deve ser menor que a Máxima.', 'warning');
            }

            if (newName === originalEquipmentId) {
                const limitsRef = doc(db, FIRESTORE_LIMITS_COLLECTION_PATH, originalEquipmentId);
                try {
                    await updateDoc(limitsRef, newLimitsData);
                    showMessage('Sucesso!', `Limites para "${originalEquipmentId}" foram atualizados.`, 'success');
                } catch (error) {
                    console.error("Erro ao salvar limites:", error);
                    showMessage('Erro', 'Não foi possível salvar as configurações. Verifique suas permissões.', 'error');
                }
            } 
            else {
                const confirmMessage = `Você está renomeando "${originalEquipmentId}" para "${newName}". O histórico de leituras antigo NÃO será migrado para o novo nome. Deseja continuar?`;
                
                showConfirmationModal(confirmMessage, async () => {
                    try {
                        const newDocRef = doc(db, FIRESTORE_LIMITS_COLLECTION_PATH, newName);
                        const newDocSnap = await getDoc(newDocRef);
                        if (newDocSnap.exists()) {
                            showMessage('Erro', `O nome de equipamento "${newName}" já existe.`, 'error');
                            document.getElementById('equipment-name').value = originalEquipmentId; 
                            return;
                        }

                        const oldDocRef = doc(db, FIRESTORE_LIMITS_COLLECTION_PATH, originalEquipmentId);
                        const oldDocSnap = await getDoc(oldDocRef);
                        if (!oldDocSnap.exists()) {
                            showMessage('Erro', `O equipamento original "${originalEquipmentId}" não foi encontrado.`, 'error');
                            return;
                        }

                        const dataToMove = oldDocSnap.data();
                        
                        const finalData = { 
                            ...dataToMove, 
                            ...newLimitsData, 
                            equipamento: newName
                        };

                        await setDoc(newDocRef, finalData);
                        await deleteDoc(oldDocRef);
                        
                        showMessage('Sucesso!', `Equipamento renomeado para "${newName}".`, 'success');
                        
                        currentEquipmentId = newName;

                    } catch (error) {
                        console.error("Erro ao renomear equipamento:", error);
                        let userMessage = 'Ocorreu um erro durante a renomeação.';
                        if (error.code === 'permission-denied') {
                            userMessage = 'Erro de permissão. Verifique as regras de segurança do Firestore para permitir a criação e exclusão de documentos.';
                        }
                        showMessage('Erro', userMessage, 'error');
                    }
                });
            }
        }
        
        function listenToLimits(equipmentId) {
            if (!db || !equipmentId) {
                currentLimits = {}; 
                updateConfigForm(null); 
                return;
            }
            const limitsDocRef = doc(db, FIRESTORE_LIMITS_COLLECTION_PATH, equipmentId);
            
            unsubscribeLimits = onSnapshot(limitsDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    currentLimits = {
                        produtivoMin: parseFloat(data.produtivoMin) || 10.0,
                        produtivoMax: parseFloat(data.produtivoMax) || 50.0,
                        paradoCentro: parseFloat(data.paradoCentro) || 70.0,
                        paradoTolerancia: parseFloat(data.paradoTolerancia) || 5.0,
                    };
                    updateConfigForm(currentLimits);
                } else {
                    currentLimits = {};
                    updateConfigForm(null);
                }
                updateDashboard(readingsCache);
            });
        }
        
        function listenToReadings(equipmentId) {
            if (!db || !equipmentId) {
                readingsCache = []; 
                updateDashboard([]);
                const historyBody = document.getElementById('readings-history');
                if(historyBody) historyBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Selecione um equipamento para ver as leituras.</td></tr>';
                return;
            }
            const readingsQuery = query(collection(db, FIRESTORE_READINGS_COLLECTION_PATH), where("equipamento", "==", equipmentId), orderBy('timestamp', 'desc'), limit(50));
            
            unsubscribeReadings = onSnapshot(readingsQuery, (snapshot) => {
                 const historyBody = document.getElementById('readings-history');
                if (snapshot.empty) {
                    readingsCache = [];
                    if(historyBody) historyBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhuma leitura encontrada para ${equipmentId}.</td></tr>`;
                } else {
                    readingsCache = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const statusServico = calculateStatus(data.prof_media, currentLimits);
                        return { ...data, statusServico };
                    });
                }
                updateDashboard(readingsCache);
            }, (error) => {
                console.error("Erro ao escutar leituras:", error);
                readingsCache = [];
                updateDashboard([]);
            });
        }

        function setupAuthListeners() {
            const loginScreen = document.getElementById('login-screen');
            const savedEmail = localStorage.getItem('savedUserEmail');
            if (savedEmail) {
                document.getElementById('email').value = savedEmail;
                document.getElementById('remember-me').checked = true;
            }

            loginScreen.addEventListener('click', e => {
                if (e.target.id === 'login-button') handleLogin();
                if (e.target.id === 'google-login-button' || e.target.closest('#google-login-button')) handleGoogleSignIn();
                if (e.target.id === 'request-login-button') document.getElementById('request-login-modal')?.classList.remove('hidden');
                if (e.target.id === 'request-login-modal' || e.target.closest('#close-modal-button')) document.getElementById('request-login-modal')?.classList.add('hidden');
            });
            loginScreen.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
            document.getElementById('request-login-form')?.addEventListener('submit', handleLoginRequest);
        }

        async function handleUserProfile(firebaseUser) {
            const userRef = doc(db, FIRESTORE_USERS_COLLECTION_PATH, firebaseUser.uid);
            const userDoc = await getDoc(userRef);

            if (userDoc.exists()) {
                currentUserProfile = userDoc.data();
                if (currentUserProfile.role === 'Pendente') {
                    showMessage('Acesso Pendente', 'Sua conta foi criada e está aguardando aprovação de um administrador.', 'warning');
                    signOut(auth);
                } else {
                    startApplication(firebaseUser);
                }
            } else {
                const newUserProfile = {
                    uid: firebaseUser.uid,
                    email: firebaseUser.email,
                    displayName: firebaseUser.displayName || firebaseUser.email.split('@')[0],
                    customId: '',
                    photoURL: firebaseUser.photoURL || '',
                    role: 'Pendente',
                    permissions: [],
                    createdAt: serverTimestamp()
                };
                await setDoc(userRef, newUserProfile);
                showMessage('Aguardando Aprovação', 'Sua conta foi criada com sucesso! Um administrador precisa aprovar seu acesso.', 'info');
                signOut(auth);
            }
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Erro no login com Google:", error);
                showMessage('Erro', `Não foi possível fazer login com o Google. (${error.code})`, 'error');
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const [btn, errEl] = [document.getElementById('login-button'), document.getElementById('login-error')];
            const loginCard = document.getElementById('login-card');
            
            errEl.classList.add('hidden');
            btn.disabled = true; btn.textContent = "Entrando...";
            if (loginCard) loginCard.style.setProperty('--animation-color', 'var(--color-primary)');

            try { 
                await signInWithEmailAndPassword(auth, email, password);
                if (rememberMe) {
                    localStorage.setItem('savedUserEmail', email);
                } else {
                    localStorage.removeItem('savedUserEmail');
                }
            } 
            catch (error) { 
                errEl.textContent = "E-mail ou senha incorretos."; 
                errEl.classList.remove('hidden'); 
                if (loginCard) loginCard.style.setProperty('--animation-color', '#ef4444');
            } 
            finally { 
                btn.disabled = false; 
                btn.textContent = "Entrar"; 
            }
        }

        function handleLoginRequest(e) {
            e.preventDefault();
            const form = e.target;
            const nome = form.elements['nome'].value;
            const id = form.elements['id'].value;
            const email = form.elements['email'].value;
            const telefone = form.elements['telefone'].value;

            if (!nome || !email || !telefone) {
                return showMessage('Campos Obrigatórios', 'Por favor, preencha Nome, E-mail e Telefone.', 'warning');
            }
            
            const whatsappNumber = '5516992886004'; 
            const message = `*Solicitação de Acesso ao Sistema de Monitoramento*\n\n*Nome:* ${nome}\n*ID:* ${id || 'Não informado'}\n*Email:* ${email}\n*Telefone:* ${telefone}`;
            const whatsappLink = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappLink, '_blank');
            showMessage('Redirecionando', 'Você será redirecionado para o WhatsApp para enviar a solicitação.', 'success');
            document.getElementById('request-login-modal').classList.add('hidden');
            form.reset();
        }

        function showLoginScreen() {
            const loginScreen = document.getElementById('login-screen');
            if(loginScreen) loginScreen.classList.add('active');
            
            document.getElementById('splashScreen')?.classList.remove('active');
            const appContainer = document.getElementById('app-container');
            if (appContainer) { appContainer.innerHTML = ''; appContainer.classList.remove('active'); }
        }

        function startApplication(user) {
            const appContainer = document.getElementById('app-container');
            if (!appContainer || appContainer.innerHTML.includes('header')) return;
            document.getElementById('login-screen')?.classList.remove('active');
            document.getElementById('splashScreen')?.classList.add('active');
            appContainer.innerHTML = getAppHTML(user, currentUserProfile);
            runInitialAnimation();
        }
        
        function runInitialAnimation() {
            const [splashLogo, splashSlogan, headerLogo, splashScreen, appContainer] = [document.getElementById('splash-logo'), document.getElementById('splash-slogan'), document.getElementById('header-logo'), document.getElementById('splashScreen'), document.getElementById('app-container')];
            setTimeout(() => { if(splashLogo) { splashLogo.style.opacity = '1'; splashLogo.style.transform = 'scale(1)'; } if(headerLogo) headerLogo.classList.add('header-logo-start'); }, 100);
            setTimeout(() => { if(splashSlogan) splashSlogan.style.opacity = '1' }, 600);
            setTimeout(() => {
                if(splashScreen) splashScreen.style.opacity = '0';
                if(headerLogo) { headerLogo.classList.remove('header-logo-start'); headerLogo.classList.add('h-10'); headerLogo.style.opacity = '1'; }
                if(appContainer) appContainer.classList.add('active');
                setTimeout(() => { 
                    if (splashScreen) splashScreen.classList.remove('active'); 
                    initializeDashboard(); 
                    const initialActiveTab = document.querySelector('.tab-button.active');
                    if (initialActiveTab && initialActiveTab.dataset.tab === 'fertirrigacao') {
                        controlFertirrigacaoSimulation(true);
                    }
                }, 1500);
            }, 2500);
        }

        function setupTabNavigation() {
            const tabsContainer = document.getElementById('tabs-container');
            tabsContainer?.addEventListener('click', e => {
                if (e.target.matches('.tab-button')) {
                    const tabId = e.target.dataset.tab;
                    
                    if (fertirrigacaoInterval) {
                        controlFertirrigacaoSimulation(false);
                    }
                    if (tabId === 'fertirrigacao') {
                        controlFertirrigacaoSimulation(true);
                    }

                    tabsContainer.className = `max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-8 ${tabId}`;
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`)?.classList.add('active');
                }
            });
        }
        
        function formatTimestamp(timestamp) {
            if (timestamp && typeof timestamp.toDate === 'function') {
                return timestamp.toDate().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium' });
            }
            return 'N/A';
        }

        function showMessage(title, message, type = 'info') {
            const existingDialog = document.getElementById('custom-dialog');
            if (existingDialog) existingDialog.remove();
            let bgColor = type === 'error' ? 'bg-red-500' : (type === 'warning' ? 'bg-amber-500' : (type === 'success' ? 'bg-emerald-500' : 'bg-blue-500'));
            const dialogContainer = document.createElement('div');
            dialogContainer.id = 'custom-dialog';
            dialogContainer.className = "fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[100] p-4";
            dialogContainer.innerHTML = `<div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full"><div class="flex items-start"><div class="p-2 rounded-full ${bgColor} text-white mr-4">${type === 'success' ? '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'}</div><div><h3 class="text-lg font-medium text-gray-900">${title}</h3><div class="mt-2"><p class="text-sm text-gray-500">${message}</p></div></div></div><div class="mt-5 text-right"><button id="dialog-ok-button" class="py-2 px-4 ${bgColor} text-white rounded-md text-sm font-semibold">OK</button></div></div>`;
            document.body.appendChild(dialogContainer);
            dialogContainer.querySelector('#dialog-ok-button')?.addEventListener('click', () => dialogContainer.remove());
        }

        async function handlePasswordReset() {
            const email = auth.currentUser.email;
            if (!email) {
                return showMessage('Erro', 'Não foi possível identificar o seu e-mail.', 'error');
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showMessage('Verifique seu E-mail', `Um link para redefinição de senha foi enviado para ${email}.`, 'success');
            } catch (error) {
                console.error("Erro ao enviar e-mail de redefinição de senha:", error);
                showMessage('Erro', 'Não foi possível enviar o e-mail de redefinição de senha.', 'error');
            }
        }

        function calculateStatus(depth, limits) {
            if (!limits || Object.keys(limits).length === 0) return 'Sem Limites';
            if (depth < 0) return 'ERRO SENSOR';
            if (depth >= (limits.paradoCentro - limits.paradoTolerancia) && depth <= (limits.paradoCentro + limits.paradoTolerancia)) return 'Manutenção';
            if (depth >= limits.produtivoMin && depth <= limits.produtivoMax) return 'Produtivo';
            return 'Parado';
        }

        function renderStatus(status, depth) {
            const statusCard = document.getElementById('current-status-card');
            const statusText = document.getElementById('status-value-text');
            if(!statusCard || !statusText) return;

            statusText.textContent = status;
            const allClasses = ['status-produtivo', 'status-parado', 'status-manutencao', 'status-erro'];
            statusCard.classList.remove(...allClasses);

            let statusClassToAdd = '';
            let animationColor = '#6b7280';

            if (status === 'Produtivo') { 
                statusClassToAdd = 'status-produtivo';
                animationColor = '#10b981';
            } 
            else if (status === 'Parado') { 
                statusClassToAdd = 'status-parado';
                animationColor = '#f59e0b';
            }
            else if (status === 'Manutenção') { 
                statusClassToAdd = 'status-manutencao';
                animationColor = '#ef4444';
            }
            else { 
                statusClassToAdd = 'status-erro';
            }

            if (statusClassToAdd) statusCard.classList.add(statusClassToAdd);
            statusCard.style.setProperty('--animation-color', animationColor);

            document.getElementById('last-depth').textContent = `${depth.toFixed(2)} cm`;
        }

        function updateConfigForm(limits) {
            const form = document.getElementById('limits-form');
            if (!form) return;
            
            form.elements['input-produtivo-min'].value = limits ? limits.produtivoMin : '';
            form.elements['input-produtivo-max'].value = limits ? limits.produtivoMax : '';
            form.elements['input-parado-centro'].value = limits ? limits.paradoCentro : '';
            form.elements['input-parado-tolerancia'].value = limits ? limits.paradoTolerancia : '';

            const limitProdutivo = document.getElementById('limit-produtivo');
            const limitParado = document.getElementById('limit-parado');
            if (limitProdutivo) {
                limitProdutivo.innerHTML = limits ? `${(limits.produtivoMin || 0).toFixed(1)} / ${(limits.produtivoMax || 0).toFixed(1)} cm` : '-- / -- cm';
            }
            if(limitParado) {
                 limitParado.innerHTML = limits ? `${(limits.paradoCentro || 0).toFixed(1)} &pm; ${(limits.paradoTolerancia || 0).toFixed(1)} cm` : '-- &pm; -- cm';
            }
        }
        
        function toggleSkeletons(showData = true) {
            const elements = ['last-depth', 'avg-depth'];
            elements.forEach(id => {
                const skeleton = document.getElementById(`${id}-skeleton`);
                const valueEl = document.getElementById(id);
                if (skeleton) skeleton.classList.toggle('hidden', showData);
                if (valueEl) valueEl.classList.toggle('hidden', !showData);
            });

            const productiveTextEl = document.getElementById('productive-percent-text');
            if (productiveTextEl) {
                const skeleton = productiveTextEl.querySelector('#productive-percent-skeleton');
                const span = productiveTextEl.querySelector('span');
                if (skeleton) skeleton.classList.toggle('hidden', showData);
                if (span) span.classList.toggle('hidden', !showData);
            }
        }
        
        function updateDashboard(readings) {
            if(!document.getElementById('depth-chart')) return;
            const hasReadings = readings && readings.length > 0;
            toggleSkeletons(hasReadings);
            
            document.getElementById('last-depth-card')?.style.setProperty('--animation-color', '#6366f1');
            document.getElementById('avg-depth-card')?.style.setProperty('--animation-color', '#a855f7');
            document.getElementById('productive-percent-card')?.style.setProperty('--animation-color', '#14b8a6');

            const avgRawDepth = hasReadings ? readings.reduce((sum, r) => sum + (r.prof_media || 0), 0) / readings.length : 0;
            const hMesa = currentLimits.paradoCentro || 0;
            const avgOperationDepth = hMesa - avgRawDepth;
            
            const badge = document.getElementById('connection-status-badge');
            const badgeText = document.getElementById('connection-status-text');

            if (!hasReadings) {
                renderStatus('Aguardando', 0);
                document.getElementById('avg-depth').textContent = `0.0 cm`;
                updateProductiveChart(0, 0);
                updateChart([], avgOperationDepth);
                if(badge) badge.classList.add('hidden');
                return;
            }

            const latestReading = readings[0];
            const latestDepth = latestReading.prof_media || 0;
            const latestTimestamp = latestReading.timestamp.toDate();
            const isConnected = (Date.now() - latestTimestamp.getTime()) < CONNECTION_TIMEOUT_MS;

            badge.classList.remove('hidden', 'bg-gray-400', 'bg-emerald-500', 'bg-red-500');
            badge.classList.add('flex');
            if (isConnected) {
                badgeText.textContent = 'Conectado';
                badge.classList.add('bg-emerald-500');
            } else {
                badgeText.textContent = 'Desconectado';
                badge.classList.add('bg-red-500');
            }

            renderStatus(calculateStatus(latestDepth, currentLimits), latestDepth);
            document.getElementById('avg-depth').textContent = `${avgOperationDepth.toFixed(2)} cm`;
            
            const productiveCount = readings.filter(r => r.statusServico === 'Produtivo').length;
            const unproductiveCount = readings.length - productiveCount;
            updateProductiveChart(productiveCount, unproductiveCount);

            const readingsHistoryBody = document.getElementById('readings-history');
            readingsHistoryBody.innerHTML = '';
            readings.forEach(r => {
                let statusClass = 'text-gray-500';
                if (r.statusServico === 'Produtivo') statusClass = 'text-emerald-600 font-medium';
                else if (r.statusServico === 'Parado') statusClass = 'text-amber-600 font-medium';
                else if (r.statusServico === 'Manutenção') statusClass = 'text-red-600 font-medium';

                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `<td class="px-6 py-3">${formatTimestamp(r.timestamp)}</td> <td class="px-6 py-3">${(r.prof_media || 0).toFixed(2)}</td> <td class="px-6 py-3 ${statusClass}">${r.statusServico}</td> <td class="px-6 py-3">${r.status_conexao}</td>`;
                readingsHistoryBody.appendChild(row);
            });

            updateChart(readings, avgOperationDepth);
        }

        function updateProductiveChart(productiveCount, unproductiveCount) {
            const ctxEl = document.getElementById('productive-chart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            const total = productiveCount + unproductiveCount;
            const percentage = total > 0 ? (productiveCount / total) * 100 : 0;

            const textEl = document.getElementById('productive-percent-text');
            if (textEl) {
                const skeleton = textEl.querySelector('#productive-percent-skeleton');
                const span = textEl.querySelector('span');
                if(skeleton) skeleton.classList.add('hidden');
                if(span) {
                    span.classList.remove('hidden');
                    span.textContent = `${percentage.toFixed(0)}%`;
                }
            }

            const chartData = {
                labels: ['Produtivo', 'Improdutivo'],
                datasets: [{
                    data: [productiveCount, unproductiveCount],
                    backgroundColor: [ 'rgb(16, 185, 129)', 'rgb(229, 231, 235)' ],
                    borderColor: '#fff',
                    borderWidth: 2,
                }]
            };

            if (productiveChart) {
                productiveChart.data = chartData;
                productiveChart.update();
            } else {
                productiveChart = new Chart(ctx, {
                    type: 'doughnut', data: chartData,
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        cutout: '75%',
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });
            }
        }

        function updateChart(readings, avgOperationDepth) {
            const ctxEl = document.getElementById('depth-chart');
            if(!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            const reversedReadings = [...readings].reverse();
            
            const chartData = {
                labels: reversedReadings.map(r => r.timestamp.toDate()),
                datasets: [
                    {
                        label: 'Profundidade (Sensor)',
                        data: reversedReadings.map(r => r.prof_media || 0),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                    },
                    {
                        label: 'Prof. Operação Média (Amostra)',
                        data: reversedReadings.map(() => avgOperationDepth),
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        fill: false,
                        borderDash: [5, 5],
                        pointRadius: 0,
                    }
                ]
            };

            if (depthChart) {
                depthChart.data = chartData;
                depthChart.options.scales.y.max = currentLimits.paradoCentro || 100;
                depthChart.update();
            } else {
                depthChart = new Chart(ctx, {
                    type: 'line', data: chartData,
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { type: 'time', time: { unit: 'minute', tooltipFormat: 'dd/MM/yy HH:mm:ss' } },
                            y: { 
                                beginAtZero: true, 
                                max: currentLimits.paradoCentro || 100,
                                title: { display: true, text: 'Profundidade (cm)' } 
                            }
                        },
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            }
        }
        
        // ====================================================================
        // LÓGICA DA ABA FERTIRRIGAÇÃO (SIMULAÇÃO)
        // ====================================================================

        function initializeLagoonsData() {
            const lagoonNames = ["Carregamento Usina A", "Carregamento Usina B", "Eucalipto Cheiroso", "Castanha", "Santa Teresinha"];
            lagoonsData = {};
            totalVolumeIn = 0;
            totalVolumeOut = 0;
            lagoonNames.forEach((name, index) => {
                const id = index + 1;
                lagoonsData[id] = {
                    id: id, name: name,
                    currentHeight: Math.random() * 2.8,
                    previousHeight: 0,
                    flowLastHour: Math.random() * 500,
                    flowLast24h: Math.random() * 12000,
                    flowSeason: 1000000 + Math.random() * 500000,
                };
                lagoonsData[id].previousHeight = lagoonsData[id].currentHeight;
            });
        }

        function simulateDataUpdate() {
            Object.values(lagoonsData).forEach(lagoa => {
                lagoa.previousHeight = lagoa.currentHeight;
                let heightChange = (Math.random() - 0.5) * 0.1;
                let newHeight = lagoa.currentHeight + heightChange;
                if (newHeight > 3) newHeight = 3;
                if (newHeight < 0) newHeight = 0;
                
                const oldVolume = calculateVolume(lagoa.currentHeight);
                lagoa.currentHeight = newHeight;
                const newVolume = calculateVolume(lagoa.currentHeight);
                
                const volumeChange = newVolume - oldVolume;
                if (volumeChange > 0) {
                    totalVolumeIn += volumeChange;
                } else {
                    totalVolumeOut += Math.abs(volumeChange);
                }

                lagoa.flowLastHour += (Math.random() - 0.5) * 10;
                lagoa.flowLast24h += (Math.random() - 0.5) * 50;
                lagoa.flowSeason += Math.random() * 100;
            });
            updateFertirrigacaoUI();
        }

        function calculateVolume(heightInMeters) {
            const H_total = 3.0, L_bottom = 35.0, W_bottom = 15.0, L_top = 40.0, W_top = 20.0;
            if (heightInMeters <= 0) return 0;
            if (heightInMeters > H_total) heightInMeters = H_total;
            const A_bottom = L_bottom * W_bottom;
            const L_h = L_bottom + (heightInMeters / H_total) * (L_top - L_bottom);
            const W_h = W_bottom + (heightInMeters / H_total) * (W_top - W_bottom);
            const A_h = L_h * W_h;
            const volume_m3 = (1/3) * heightInMeters * (A_bottom + A_h + Math.sqrt(A_bottom * A_h));
            return volume_m3 * 1000;
        }

        function updateFertirrigacaoUI() {
            if (!document.getElementById('fertirrigacao-sub-tabs')) return;

            Object.values(lagoonsData).forEach(lagoa => {
                const id = lagoa.id, altura = lagoa.currentHeight, espacoVazio = 3.0 - altura;
                const volumeL = calculateVolume(altura), volumeM3 = volumeL / 1000;
                const percent = (altura / 3.0) * 100;
                const variacao = altura - lagoa.previousHeight;

                document.getElementById(`lagoa-altura-${id}`).textContent = altura.toFixed(2);
                document.getElementById(`lagoa-espaco-${id}`).textContent = espacoVazio.toFixed(2);
                document.getElementById(`lagoa-volume-litros-${id}`).textContent = volumeL.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
                document.getElementById(`lagoa-volume-m3-${id}`).textContent = `(${volumeM3.toFixed(2)} m³)`;
                document.getElementById(`lagoa-percent-${id}`).textContent = `${percent.toFixed(0)}%`;
                
                const gaugeEl = document.getElementById(`lagoa-gauge-${id}`);
                if(gaugeEl) {
                    gaugeEl.style.height = `${percent}%`;
                    gaugeEl.classList.remove('bg-cyan-400', 'bg-yellow-400', 'bg-orange-600', 'bg-red-600');
                    if (percent >= 95) gaugeEl.classList.add('bg-red-600');
                    else if (percent >= 90) gaugeEl.classList.add('bg-orange-600');
                    else if (percent >= 80) gaugeEl.classList.add('bg-yellow-400');
                    else gaugeEl.classList.add('bg-cyan-400');
                }
                
                const variacaoEl = document.getElementById(`lagoa-variacao-${id}`);
                const alertGlow = document.getElementById(`lagoa-alert-glow-${id}`);
                
                if (variacao > 0.001) {
                    variacaoEl.innerHTML = `<span class="material-symbols-outlined text-red-400">arrow_upward</span><span class="text-red-400">Enchendo</span>`;
                    alertGlow.style.backgroundColor = 'rgba(220, 38, 38, 0.4)';
                    alertGlow.classList.remove('opacity-0');
                } else if (variacao < -0.001) {
                    variacaoEl.innerHTML = `<span class="material-symbols-outlined text-green-400">arrow_downward</span><span class="text-green-400">Esvaziando</span>`;
                    alertGlow.style.backgroundColor = 'rgba(16, 185, 129, 0.4)';
                    alertGlow.classList.remove('opacity-0');
                } else {
                    variacaoEl.innerHTML = `<span class="material-symbols-outlined">horizontal_rule</span><span>Estável</span>`;
                    alertGlow.classList.add('opacity-0');
                }
                
                const alertIcon = document.getElementById(`lagoa-alert-icon-${id}`);
                const card = document.getElementById(`lagoa-card-${id}`);
                if (altura >= 2.8) {
                    alertIcon.classList.remove('hidden');
                    card.classList.add('border-red-500');
                    alertGlow.style.backgroundColor = 'rgba(220, 38, 38, 0.6)'; // Torna o brilho mais forte no alerta máximo
                    alertGlow.classList.remove('opacity-0');
                } else {
                    alertIcon.classList.add('hidden');
                    card.classList.remove('border-red-500');
                }

                document.getElementById(`flow-1h-${id}`).textContent = `${lagoa.flowLastHour.toFixed(2)} m³`;
                document.getElementById(`flow-24h-${id}`).textContent = `${lagoa.flowLast24h.toFixed(2)} m³`;
                document.getElementById(`flow-season-${id}`).textContent = `${lagoa.flowSeason.toLocaleString('pt-BR', {maximumFractionDigits:0})} m³`;
            });

            // Update new summary cards
            document.getElementById('total-volume-in-litros').textContent = totalVolumeIn.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
            document.getElementById('total-volume-in-m3').textContent = `(${(totalVolumeIn / 1000).toFixed(2)} m³)`;
            document.getElementById('total-volume-out-litros').textContent = totalVolumeOut.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
            document.getElementById('total-volume-out-m3').textContent = `(${(totalVolumeOut / 1000).toFixed(2)} m³)`;

            const metaInput = document.getElementById('meta-volume-input');
            const metaValue = parseFloat(metaInput.value) || 0;
            const totalInM3 = totalVolumeIn / 1000;
            let progress = metaValue > 0 ? (totalInM3 / metaValue) * 100 : 0;
            if (progress > 100) progress = 100;
            
            const progressBar = document.getElementById('meta-progress-bar');
            let barColor = '#f59e0b'; // Amarelo
            if (progress >= 85) {
                barColor = '#40800c'; // Verde
            } else if (progress >= 50) {
                barColor = '#2563eb'; // Azul
            }
            progressBar.style.backgroundColor = barColor;
            progressBar.style.width = `${progress}%`;
            document.getElementById('meta-progress-text').textContent = `Progresso da Meta (${progress.toFixed(1)}%)`;

            const summaryGlow = document.getElementById('summary-alert-glow');
            if (summaryGlow) {
                if (totalVolumeIn > totalVolumeOut) {
                    summaryGlow.style.backgroundColor = 'rgba(220, 38, 38, 0.4)'; // Red
                    summaryGlow.classList.remove('opacity-0');
                } else {
                    summaryGlow.style.backgroundColor = 'rgba(16, 185, 129, 0.4)'; // Green
                    summaryGlow.classList.remove('opacity-0');
                }
            }

            updateLagoasChart();
        }

        const footerDataLabels = {
            id: 'footerDataLabels',
            afterDatasetsDraw(chart, args, pluginOptions) {
                const { ctx } = chart;
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta.hidden) {
                        meta.data.forEach((element, index) => {
                            const valueString = dataset.data[index].toFixed(0) + '%';
                            ctx.save();
                            ctx.font = '700 12px Inter, sans-serif';
                            ctx.fillStyle = '#ffffff';
                            ctx.shadowColor = 'rgba(0,0,0,0.7)';
                            ctx.shadowBlur = 4;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            const yPos = element.base - 8;
                             if (yPos > element.y + 15) { 
                                ctx.fillText(valueString, element.x, yPos);
                            }
                            ctx.restore();
                        });
                    }
                });
            }
        };


        function updateLagoasChart() {
            const ctxEl = document.getElementById('lagoas-chart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            const chartLabels = Object.values(lagoonsData).map(l => l.name);
            const chartDataPoints = Object.values(lagoonsData).map(l => (l.currentHeight / 3.0) * 100);

            const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
            gradient.addColorStop(0, 'rgba(6, 182, 212, 1)');   // ciano-500
            gradient.addColorStop(1, 'rgba(8, 145, 178, 0.3)'); // ciano-600 com opacidade

            const chartData = {
                labels: chartLabels,
                datasets: [{
                    label: 'Nível de Preenchimento (%)', 
                    data: chartDataPoints,
                    backgroundColor: gradient,
                    borderColor: 'rgba(107, 227, 242, 0.8)',
                    borderWidth: 2, 
                    borderRadius: 5,
                    hoverBackgroundColor: 'rgba(6, 182, 212, 1)',
                    hoverBorderColor: '#fff'
                }]
            };

            if (lagoasChart) {
                lagoasChart.data = chartData;
                lagoasChart.update();
            } else {
                lagoasChart = new Chart(ctx, { type: 'bar', data: chartData,
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                max: 100, 
                                grid: { color: 'rgba(148, 163, 184, 0.2)' },
                                ticks: { 
                                    color: '#94a3b8',
                                    callback: value => `${value}%`
                                } 
                            }, 
                            x: { 
                                grid: { display: false },
                                ticks: { color: '#94a3b8' } 
                            } 
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 12 },
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        const dataIndex = context.dataIndex;
                                        const allLagoons = Object.values(lagoonsData);
                                        const lagoa = allLagoons[dataIndex];
                                        if (!lagoa) return 'Sem dados';

                                        const volumeL = calculateVolume(lagoa.currentHeight);
                                        const volumeM3 = volumeL / 1000;
                                        const variacao = lagoa.currentHeight - lagoa.previousHeight;
                                        let variacaoText;
                                        if (variacao > 0.001) variacaoText = 'Enchendo';
                                        else if (variacao < -0.001) variacaoText = 'Esvaziando';
                                        else variacaoText = 'Estável';
                                        
                                        return [
                                            `Nível: ${(lagoa.currentHeight/3.0 * 100).toFixed(1)}%`,
                                            `Altura: ${lagoa.currentHeight.toFixed(2)}m`,
                                            `Espaço Vazio: ${(3.0 - lagoa.currentHeight).toFixed(2)}m`,
                                            `Volume: ${volumeL.toLocaleString('pt-BR', {maximumFractionDigits:0})} L`,
                                            `Volume (m³): ${volumeM3.toFixed(2)} m³`,
                                            `Variação: ${variacaoText}`
                                        ];
                                    }
                                }
                            }
                        }
                    },
                    plugins: [footerDataLabels]
                });
            }
        }

        function setupFertirrigacaoSubTabs() {
            const tabsContainer = document.getElementById('fertirrigacao-sub-tabs');
            const playPauseBtn = document.getElementById('play-pause-btn');
            if (!tabsContainer || !playPauseBtn) return;

            tabsContainer.addEventListener('click', (e) => {
                const targetTab = e.target.closest('.fert-sub-tab');
                if (targetTab) {
                    if (fertirrigacaoSubTabInterval) { 
                        clearInterval(fertirrigacaoSubTabInterval);
                        fertirrigacaoSubTabInterval = null;
                        playPauseBtn.innerHTML = `<span class="material-symbols-outlined">play_arrow</span> Autoplay`;
                        playPauseBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
                        playPauseBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white');
                    }
                    tabsContainer.querySelectorAll('.fert-sub-tab').forEach(t => t.classList.remove('active'));
                    targetTab.classList.add('active');
                    document.querySelectorAll('.fert-sub-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(targetTab.dataset.tab).classList.add('active');
                }
            });

            const cycleTabs = () => {
                const tabs = Array.from(tabsContainer.querySelectorAll('.fert-sub-tab'));
                const activeIndex = tabs.findIndex(t => t.classList.contains('active'));
                const nextIndex = (activeIndex + 1) % tabs.length;
                
                const nextTab = tabs[nextIndex];
                tabsContainer.querySelectorAll('.fert-sub-tab').forEach(t => t.classList.remove('active'));
                nextTab.classList.add('active');
                document.querySelectorAll('.fert-sub-content').forEach(c => c.classList.remove('active'));
                document.getElementById(nextTab.dataset.tab).classList.add('active');
            };

            playPauseBtn.addEventListener('click', () => {
                if (fertirrigacaoSubTabInterval) {
                    clearInterval(fertirrigacaoSubTabInterval);
                    fertirrigacaoSubTabInterval = null;
                    playPauseBtn.innerHTML = `<span class="material-symbols-outlined">play_arrow</span> Autoplay`;
                    playPauseBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    playPauseBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white');
                } else {
                    cycleTabs(); 
                    fertirrigacaoSubTabInterval = setInterval(cycleTabs, 20000); // 20 segundos
                    playPauseBtn.innerHTML = `<span class="material-symbols-outlined">pause</span> Pausar`;
                    playPauseBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    playPauseBtn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
                }
            });
        }

        function controlFertirrigacaoSimulation(start) {
            if (start && !fertirrigacaoInterval) {
                initializeLagoonsData(); 
                updateFertirrigacaoUI();
                setupFertirrigacaoSubTabs();
                // Atualiza a cada 10 minutos (10 * 60 * 1000 = 600000 ms)
                fertirrigacaoInterval = setInterval(simulateDataUpdate, 600000);

                const metaInput = document.getElementById('meta-volume-input');
                if (metaInput) {
                    const updateMetaDisplay = () => {
                        const metaValue = parseFloat(metaInput.value) || 0;
                        const metaLitros = metaValue * 1000;
                        const displayEl = document.getElementById('meta-volume-litros');
                        if (displayEl) {
                           displayEl.textContent = `= ${metaLitros.toLocaleString('pt-BR')} L`;
                        }
                    };
                    metaInput.addEventListener('input', updateMetaDisplay);
                    updateMetaDisplay(); // Chama uma vez para exibir o valor inicial
                }

            } else if (!start && fertirrigacaoInterval) {
                clearInterval(fertirrigacaoInterval);
                fertirrigacaoInterval = null;
                if(fertirrigacaoSubTabInterval) {
                    clearInterval(fertirrigacaoSubTabInterval);
                    fertirrigacaoSubTabInterval = null;
                }
            }
        }
        
        // ====================================================================
        // FIM DA LÓGICA DE FERTIRRIGAÇÃO
        // ====================================================================

        async function handleAddUser(e) {
            e.preventDefault();
            const form = e.target;
            const email = form.elements['new-user-email'].value;
            const password = form.elements['new-user-password'].value;
            const displayName = form.elements['new-user-name'].value;
            const customId = form.elements['new-user-id'].value;

            if (!displayName) {
                return showMessage('Erro', 'O campo "Nome do Usuário" é obrigatório.', 'error');
            }
            
            try {
                const newUserProfile = {
                    email: email,
                    displayName: displayName,
                    customId: customId,
                    photoURL: '',
                    role: 'Operação',
                    permissions: [],
                    createdAt: serverTimestamp()
                };

                const userRef = doc(collection(db, FIRESTORE_USERS_COLLECTION_PATH));
                await setDoc(userRef, { ...newUserProfile, uid: userRef.id, isManual: true });

                showMessage('Sucesso', `Perfil para ${email} criado! O usuário precisa se registrar com este e-mail para ativar a conta.`, 'success');
                form.reset();
                loadAdminData('gerenciar');

            } catch(error) {
                console.error("Erro ao criar usuário:", error);
                let msg = 'Não foi possível criar o perfil do utilizador.';
                if (error.code === 'permission-denied') msg = 'Erro de permissão ao criar o perfil no Firestore.';
                showMessage('Erro', msg, 'error');
            }
        }
        
        function setupAdminTabs() {
            const adminTabsContainer = document.getElementById('admin-sub-tabs');
            adminTabsContainer?.addEventListener('click', (e) => {
                if (e.target.matches('.admin-sub-tab')) {
                    const tabId = e.target.dataset.tab;
                    adminTabsContainer.querySelectorAll('.admin-sub-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.admin-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(`${tabId}-content`).classList.remove('hidden');
                    loadAdminData(tabId);
                }
            });
        }

        async function loadAdminData(tab) {
            const container = document.getElementById(`${tab}-list`);
            if (!container) return;
            container.innerHTML = `<p>Carregando...</p>`;

            let q;
            if (tab === 'pendentes') {
                q = query(collection(db, FIRESTORE_USERS_COLLECTION_PATH), where("role", "==", "Pendente"));
            } else {
                q = query(collection(db, FIRESTORE_USERS_COLLECTION_PATH), where("role", "!=", "Pendente"));
            }

            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = `<p class="text-gray-500">Nenhum usuário encontrado.</p>`;
                    return;
                }
                container.innerHTML = querySnapshot.docs.map(doc => getUserCardHTML(doc.data(), tab)).join('');
                attachAdminButtonListeners(container);
            } catch (error) {
                console.error(`Erro ao carregar dados de ${tab}:`, error);
                container.innerHTML = `<p class="text-red-500">Falha ao carregar dados. Verifique as permissões do Firestore.</p>`;
            }
        }

        function getUserCardHTML(user, type) {
            const permissions = user.permissions?.join(', ') || 'Nenhuma';
            if (type === 'pendentes') {
                return `<div class="p-4 border rounded-lg flex justify-between items-center" id="user-card-${user.uid}">
                                <div><p class="font-bold">${user.displayName}</p><p class="text-sm text-gray-600">${user.email}</p></div>
                                <div class="flex gap-2">
                                    <button data-uid="${user.uid}" data-action="approve" class="action-user-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Aprovar</button>
                                    <button data-uid="${user.uid}" data-action="reject" class="action-user-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Rejeitar</button>
                                </div>
                            </div>`;
            } else {
                return `<div class="p-4 border rounded-lg" id="user-card-${user.uid}">
                                <div class="flex justify-between items-center">
                                    <div><p class="font-bold">${user.displayName}</p><p class="text-sm text-gray-600">${user.email}</p></div>
                                    <div class="flex gap-2">
                                        <button data-uid="${user.uid}" data-action="manage" class="action-user-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">Editar</button>
                                        <button data-uid="${user.uid}" data-action="delete" class="action-user-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Excluir</button>
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-gray-500">
                                    <p><strong>Nível:</strong> ${user.role}</p>
                                    ${user.role === 'Operação' || user.role === 'Lider' ? `<p><strong>Permissões:</strong> ${permissions}</p>` : ''}
                                </div>
                            </div>`;
            }
        }

        function attachAdminButtonListeners(container) {
            container.querySelectorAll('.action-user-btn').forEach(btn => btn.addEventListener('click', e => {
                const uid = e.target.dataset.uid;
                const action = e.target.dataset.action;
                if (action === 'delete' || action === 'reject') {
                    showConfirmationModal('Tem certeza que deseja excluir este perfil de usuário? A autenticação do usuário não será removida.', () => deleteUserProfile(uid));
                } else {
                    openManagementModal(uid, action === 'approve');
                }
            }));
        }

        async function deleteUserProfile(uid) {
            try {
                await deleteDoc(doc(db, FIRESTORE_USERS_COLLECTION_PATH, uid));
                showMessage('Sucesso', 'Perfil de usuário removido do banco de dados.', 'success');
                loadAdminData('pendentes');
                loadAdminData('gerenciar');
            } catch(error) {
                console.error("Erro ao excluir usuário:", error);
                showMessage('Erro de Permissão', 'Não foi possível excluir o perfil do usuário. Verifique as regras do Firestore.', 'error');
            }
        }
        
        async function openManagementModal(uid, isApproval) {
            try {
                const userRef = doc(db, FIRESTORE_USERS_COLLECTION_PATH, uid);
                const userDoc = await getDoc(userRef);
                if (!userDoc.exists()) return showMessage('Erro', 'Usuário não encontrado.', 'error');
                const userData = userDoc.data();

                const modalPlaceholder = document.getElementById('modal-placeholder');
                modalPlaceholder.innerHTML = getManagementModalHTML(userData, isApproval);
                const modal = document.getElementById('management-modal');
                const form = document.getElementById('management-form');
                const permissionsDiv = document.getElementById('permissions-div');

                form.querySelectorAll('input[name="role"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        permissionsDiv.classList.toggle('hidden', e.target.value === 'Master');
                    });
                });
                
                modal.classList.remove('hidden');

                const closeModal = () => modal.remove();
                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'management-modal' || e.target.id === 'close-management-modal' || e.target.id === 'cancel-management') {
                        closeModal();
                    }
                });

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newRole = form.role.value;
                    let permissions = [];
                    if (newRole !== 'Master') {
                        form.querySelectorAll('input[name="permissions"]:checked').forEach(checkbox => {
                            permissions.push(checkbox.value);
                        });
                    }
                    
                    try {
                        await updateDoc(userRef, { role: newRole, permissions: permissions });
                        showMessage('Sucesso', 'Usuário atualizado!', 'success');
                        if (isApproval) {
                            loadAdminData('pendentes');
                        }
                        loadAdminData('gerenciar');
                        closeModal();
                    } catch (error) {
                        console.error("Erro ao gerenciar usuário:", error);
                        showMessage('Erro de Permissão', 'Não foi possível atualizar o usuário. Verifique as regras do Firestore.', 'error');
                    }
                });
            } catch (error) {
                console.error("Erro ao abrir modal de gerenciamento:", error);
                showMessage('Erro', 'Não foi possível carregar os dados do usuário. Verifique as regras do Firestore.', 'error');
            }
        }

        function showConfirmationModal(message, onConfirm) {
            const modalPlaceholder = document.getElementById('modal-placeholder');
            modalPlaceholder.innerHTML = `<div id="confirmation-modal" class="modal-container fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div class="modal-content bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-4">Confirmação</h3>
                    <p class="mb-6">${message}</p>
                    <div class="flex justify-end gap-4">
                        <button id="cancel-confirmation" class="px-4 py-2 bg-gray-200 rounded">Cancelar</button>
                        <button id="confirm-action" class="px-4 py-2 bg-red-600 text-white rounded">Confirmar</button>
                    </div>
                </div>
            </div>`;
            const modal = document.getElementById('confirmation-modal');
            const closeModal = () => modal.remove();
            
            modal.addEventListener('click', (e) => {
                if(e.target.id === 'confirmation-modal' || e.target.id === 'cancel-confirmation') closeModal();
            });
            document.getElementById('confirm-action').addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
        }


        // --- HTML TEMPLATES ---
        function getLoginHTML() { 
            return `
            <div id="login-card" class="animated-border login-card-border-top max-w-md w-full bg-white shadow-2xl">
                <div class="card-content-wrapper space-y-6">
                    <div class="text-center">
                        <img class="mx-auto h-20 w-auto" src="https://usinapitangueiras.com.br/wp-content/uploads/2020/04/usina-pitangueiras-logo.png" alt="Logo Usina Pitangueiras">
                        <h2 class="mt-4 text-3xl font-extrabold text-gray-900">Acessar Sistema</h2>
                    </div>
                    
                    <form id="login-form" class="space-y-4" onsubmit="return false;">
                        <div><input id="email" type="email" autocomplete="email" required class="w-full px-3 py-2 border rounded-md" placeholder="Endereço de e-mail"></div>
                        <div><input id="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 border rounded-md" placeholder="Senha"></div>
                        <div class="flex items-center"><input id="remember-me" type="checkbox" class="h-4 w-4 text-emerald-600 rounded"><label for="remember-me" class="ml-2 block text-sm">Lembrar usuário</label></div>
                        <div id="login-error" class="text-red-600 text-sm text-center hidden"></div>
                        <div class="flex items-center gap-2 pt-2">
                            <button type="button" id="login-button" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md">Entrar</button>
                            <button type="button" id="google-login-button" title="Acessar com Google" class="flex-shrink-0 p-2 border rounded-md shadow-sm bg-white hover:bg-gray-50">
                                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C44.962,32.645,48,27.135,48,20C48,18.896,47.9,17.82,47.6,16.8z"></path></svg>
                            </button>
                            <button type="button" id="request-login-button" class="w-full py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md">Solicitar Login</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="request-login-modal" class="modal-container hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                 <div class="modal-content bg-white rounded-lg shadow-2xl p-8 max-w-md w-full relative" onclick="event.stopPropagation()">
                     <h2 class="text-2xl font-bold text-gray-900 mb-6">Solicitar Acesso</h2>
                     <button id="close-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
                     <form id="request-login-form" class="space-y-4">
                         <div><label for="req-nome" class="block text-sm font-medium text-gray-700">Nome Completo <span class="text-red-500">*</span></label><input id="req-nome" name="nome" type="text" required class="mt-1 w-full p-2 border rounded-md"></div>
                         <div><label for="req-id" class="block text-sm font-medium text-gray-700">ID (Opcional)</label><input id="req-id" name="id" type="text" class="mt-1 w-full p-2 border rounded-md"></div>
                         <div><label for="req-email" class="block text-sm font-medium text-gray-700">E-mail <span class="text-red-500">*</span></label><input id="req-email" name="email" type="email" required class="mt-1 w-full p-2 border rounded-md"></div>
                         <div><label for="req-telefone" class="block text-sm font-medium text-gray-700">Telefone <span class="text-red-500">*</span></label><input id="req-telefone" name="telefone" type="tel" required class="mt-1 w-full p-2 border rounded-md"></div>
                         <button type="submit" id="send-request-button" class="w-full py-2 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-md">Enviar Solicitação</button>
                     </form>
                 </div>
            </div>`; 
        }

        function getSplashHTML() { return `<img id="splash-logo" src="https://usinapitangueiras.com.br/wp-content/uploads/2020/04/usina-pitangueiras-logo.png" alt="Logo Usina Pitangueiras" class="opacity-0 scale-125 h-36"><p id="splash-slogan" class="text-gray-700 text-xl font-semibold opacity-0 mt-4">A energia que move a região</p>`; }
        
        function getAppHTML(user, profile) {
            const username = profile.displayName || user.email.split('@')[0];
            const canSee = (tab) => {
                if (profile.role === 'Master') return true;
                return profile.permissions && profile.permissions.includes(tab);
            };

            const allTabs = ['implementos', 'fertirrigacao', 'limites'];
            if (profile.role === 'Master') allTabs.push('cadastro');
            
            const visibleTabs = allTabs.filter(canSee);
            const firstVisibleTab = visibleTabs[0] || null;

            const initials = username.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const avatar = profile.photoURL 
                ? `<img src="${profile.photoURL}" alt="Avatar" class="h-12 w-12 rounded-full object-cover">`
                : `<div class="h-12 w-12 rounded-full bg-emerald-700 text-white flex items-center justify-center text-xl font-bold">${initials}</div>`;

            return `
                <header class="shadow-md bg-white sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex justify-between items-center">
                        <img id="header-logo" src="https://usinapitangueiras.com.br/wp-content/uploads/2020/04/usina-pitangueiras-logo.png" alt="Logo Usina Pitangueiras" class="header-logo opacity-0">
                        <h1 class="text-xl md:text-2xl font-extrabold text-gray-900 tracking-tight hidden sm:block">Monitoramento Operacional</h1>
                        <div class="flex items-center space-x-4">
                            ${avatar}
                            <div>
                                <p class="font-bold text-sm">${username}</p>
                                ${profile.customId ? `<p class="text-xs text-gray-500">ID: ${profile.customId}</p>` : ''}
                            </div>
                            <button id="change-password-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-3 rounded-lg text-sm">Trocar Senha</button>
                            <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm">Sair</button>
                        </div>
                    </div>
                    <nav id="tabs-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-8 ${firstVisibleTab || ''}">
                        ${canSee('implementos') ? `<button class="tab-button ${firstVisibleTab === 'implementos' ? 'active' : ''}" data-tab="implementos">Implementos</button>` : ''}
                        ${canSee('fertirrigacao') ? `<button class="tab-button ${firstVisibleTab === 'fertirrigacao' ? 'active' : ''}" data-tab="fertirrigacao">Fertirrigação</button>` : ''}
                        ${canSee('limites') ? `<button class="tab-button ${firstVisibleTab === 'limites' ? 'active' : ''}" data-tab="limites">Limites</button>` : ''}
                        ${profile.role === 'Master' ? `<button class="tab-button ${firstVisibleTab === 'cadastro' ? 'active' : ''}" data-tab="cadastro">Cadastro</button>` : ''}
                    </nav>
                </header>
                <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    <div id="implementos-tab" class="tab-content ${firstVisibleTab === 'implementos' ? 'active' : ''}">${getImplementosTabHTML()}</div>
                    <div id="fertirrigacao-tab" class="tab-content ${firstVisibleTab === 'fertirrigacao' ? 'active' : ''}">${getFertirrigacaoTabHTML()}</div>
                    <div id="limites-tab" class="tab-content ${firstVisibleTab === 'limites' ? 'active' : ''}">${getLimitesTabHTML()}</div>
                    ${profile.role === 'Master' ? `<div id="cadastro-tab" class="tab-content ${firstVisibleTab === 'cadastro' ? 'active' : ''}">${getAdminHTML()}</div>` : ''}
                </main>
            `;
        }
        
        function getImplementosTabHTML() {
            return `
            <div class="flex justify-between items-center mb-8 border-b pb-4">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Status em Tempo Real</h2>
                    <div id="connection-status-badge" class="hidden items-center gap-2 px-3 py-1 text-sm font-bold text-white bg-gray-400 rounded-full">
                        <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-white"></span></span>
                        <span id="connection-status-text">Aguardando</span>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="equipment-select-implementos" class="text-sm font-medium">Equipamento:</label>
                    <select id="equipment-select-implementos" class="rounded-md border-gray-300 shadow-sm"></select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div id="last-depth-card" class="metric-card animated-border h-52">
                    <div class="card-content-wrapper h-full flex flex-col justify-center">
                        <p class="data-label">Última Profundidade</p>
                        <div id="last-depth-skeleton" class="mt-1 h-9 w-3/4 rounded-md bg-gray-200 animate-pulse"></div>
                        <p class="data-value text-indigo-700 hidden" id="last-depth">0.00 cm</p>
                    </div>
                </div>
                
                <div id="avg-depth-card" class="metric-card animated-border h-52">
                    <div class="card-content-wrapper h-full flex flex-col justify-center">
                        <p class="data-label">Prof. Operação Média</p>
                        <div id="avg-depth-skeleton" class="mt-1 h-9 w-3/4 rounded-md bg-gray-200 animate-pulse"></div>
                        <p class="data-value text-purple-700 hidden" id="avg-depth">0.0 cm</p>
                    </div>
                </div>

                <div id="productive-percent-card" class="metric-card animated-border h-52">
                    <div class="card-content-wrapper h-full flex flex-col justify-center">
                        <p class="data-label">Percentual Produtivo</p>
                        <div class="relative mx-auto mt-2" style="width: 120px; height: 120px;">
                            <canvas id="productive-chart"></canvas>
                            <div id="productive-percent-text" class="absolute inset-0 flex items-center justify-center text-3xl font-extrabold text-teal-700">
                                <div id="productive-percent-skeleton" class="h-9 w-2/4 rounded-md bg-gray-200 animate-pulse"></div>
                                <span class="hidden">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="current-status-card" class="metric-card animated-border h-52">
                    <div class="card-content-wrapper h-full flex flex-col justify-center text-center">
                        <p class="data-label text-xl mb-2">Status Atual</p>
                        <p class="text-4xl font-extrabold" id="status-value-text" style="line-height: 1.2;">Aguardando</p>
                    </div>
                </div>
            </div>

            <div class="mb-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Gráfico de Profundidade (Últimas Leituras)</h2>
                <div class="bg-white p-4 rounded-xl shadow-xl">
                    <canvas id="depth-chart" style="height: 300px;"></canvas>
                </div>
                <div class="text-center text-xs text-gray-500 mt-2">
                    <span class="font-semibold">Limites Atuais:</span>
                    <span class="text-emerald-600 mx-2">Produtivo: <strong id="limit-produtivo">-- / -- cm</strong></span> | 
                    <span class="text-red-600 ml-2">Manutenção: <strong id="limit-parado">-- &pm; -- cm</strong></span>
                </div>
            </div>
            
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Últimas Leituras (Firestore Log)</h2>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-xl">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead><tr class="table-header"><th scope="col" class="px-6 py-3 text-left">Timestamp</th><th scope="col" class="px-6 py-3 text-left">Prof. Média (cm)</th><th scope="col" class="px-6 py-3 text-left">Status Serviço</th><th scope="col" class="px-6 py-3 text-left">Conexão</th></tr></thead>
                        <tbody id="readings-history" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Aguardando conexão com o Firestore...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        function getFertirrigacaoTabHTML() {
            const lagoonNames = ["Carregamento Usina A", "Carregamento Usina B", "Eucalipto Cheiroso", "Castanha", "Santa Teresinha"];

            const cardsHTML = lagoonNames.map((name, index) => {
                const id = index + 1;
                return `
                <div id="lagoa-card-${id}" class="zoom-hover-card bg-slate-800 rounded-xl shadow-lg p-6 relative overflow-hidden border-2 border-transparent">
                    <div id="lagoa-alert-glow-${id}" class="absolute inset-0 rounded-xl blur-2xl opacity-0 transition-opacity duration-500 animate-pulse"></div>
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-sm text-slate-400">Lagoa ${id}</p>
                            <h3 class="text-xl font-bold text-white">${name}</h3>
                        </div>
                        <div id="lagoa-alert-icon-${id}" class="p-2 bg-red-500/20 text-red-400 rounded-full hidden">
                            <span class="material-symbols-outlined">warning</span>
                        </div>
                    </div>
                    <div class="flex mt-4 items-end gap-6 z-10 relative">
                        <div class="w-16 h-40 bg-slate-700 rounded-full flex flex-col-reverse relative overflow-hidden border border-slate-600">
                            <div id="lagoa-gauge-${id}" class="w-full bg-cyan-400 rounded-b-full transition-all duration-500" style="height: 0%;"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="lagoa-percent-${id}" class="text-white font-bold text-lg drop-shadow-md">0%</span>
                            </div>
                        </div>
                        <div class="flex-1 space-y-3">
                            <div>
                                <p class="text-xs text-slate-400 uppercase">Altura / Espaço Vazio</p>
                                <p class="text-xl font-semibold text-white">
                                    <span id="lagoa-altura-${id}">0.00</span>m / <span id="lagoa-espaco-${id}">3.00</span>m
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase">Volume Estimado</p>
                                <p class="text-xl font-semibold text-white"><span id="lagoa-volume-litros-${id}">0</span> L</p>
                                <p class="text-sm text-slate-400 -mt-1"><span id="lagoa-volume-m3-${id}">(0.00 m³)</span></p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase">Variação</p>
                                <div id="lagoa-variacao-${id}" class="flex items-center gap-2 text-slate-400 font-medium">
                                    <span class="material-symbols-outlined">horizontal_rule</span>
                                    <span>Estável</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            const summaryCardHTML = `
                <div id="summary-card" class="zoom-hover-card bg-slate-800 rounded-xl shadow-lg relative overflow-hidden">
                    <div id="summary-alert-glow" class="absolute inset-0 rounded-xl blur-2xl transition-opacity duration-500 animate-pulse opacity-0"></div>
                    <div class="h-full flex flex-col justify-between space-y-6 p-6 text-white relative z-10">
                        <div>
                            <h3 class="text-lg font-bold text-white">Volume Acumulado de Entrada</h3>
                            <p class="text-3xl font-bold text-cyan-400"><span id="total-volume-in-litros">0</span> L</p>
                            <p class="text-base text-slate-300 -mt-1"><span id="total-volume-in-m3">(0.00 m³)</span></p>
                        </div>
                        <div class="border-t border-slate-600"></div>
                        <div>
                            <h3 class="text-lg font-bold text-white">Volume Acumulado de Saída</h3>
                            <p class="text-3xl font-bold text-amber-400"><span id="total-volume-out-litros">0</span> L</p>
                            <p class="text-base text-slate-300 -mt-1"><span id="total-volume-out-m3">(0.00 m³)</span></p>
                        </div>
                        <div class="border-t border-slate-600"></div>
                        <div>
                            <h3 class="text-lg font-bold text-white mb-2">Meta de Volume (m³ / L)</h3>
                            <div class="flex items-center gap-2">
                            <input type="number" id="meta-volume-input" class="bg-slate-700 border border-slate-600 rounded-md p-2 w-full text-white" placeholder="Definir meta em m³" value="15000" ${currentUserProfile.role !== 'Master' ? 'readonly' : ''}>
                            <span id="meta-volume-litros" class="text-sm text-slate-400 whitespace-nowrap"></span>
                            </div>
                            <div class="mt-3">
                                <p id="meta-progress-text" class="text-sm text-slate-400 mb-1">Progresso da Meta (0%)</p>
                                <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden border border-slate-600">
                                    <div id="meta-progress-bar" class="h-4 rounded-full transition-all duration-500" style="width: 0%; background-color: #f59e0b;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const flowRowsHTML = lagoonNames.map((name, index) => {
                const id = index + 1;
                return `<tr>
                    <td class="font-semibold text-white">${name}</td>
                    <td class="font-mono" id="flow-1h-${id}">0.00 m³</td>
                    <td class="font-mono" id="flow-24h-${id}">0.00 m³</td>
                    <td class="font-mono text-cyan-400" id="flow-season-${id}">0 m³</td>
                </tr>`;
            }).join('');

            return `
            <div class="flex justify-between items-center mb-6">
                <nav id="fertirrigacao-sub-tabs" class="flex gap-2 items-center">
                    <button class="fert-sub-tab active" data-tab="niveis-content">Níveis Atuais</button>
                    <button class="fert-sub-tab" data-tab="vazao-content">Vazão e Acumulado</button>
                    <button class="fert-sub-tab" data-tab="grafico-content">Gráfico Geral</button>
                </nav>
                <button id="play-pause-btn" class="flex items-center gap-2 px-4 py-2 text-sm bg-red-500 text-white rounded-full shadow hover:bg-red-600 transition">
                    <span class="material-symbols-outlined">play_arrow</span> Autoplay
                </button>
            </div>

            <div id="niveis-content" class="fert-sub-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                   ${cardsHTML}
                   ${summaryCardHTML}
                </div>
            </div>
            <div id="vazao-content" class="fert-sub-content">
                <div class="bg-slate-800 rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-white mb-4">Resumo de Vazão e Acumulado de Safra (Simulado)</h3>
                    <div class="overflow-x-auto">
                        <table id="vazao-table" class="w-full">
                            <thead>
                                <tr>
                                    <th>Lagoa</th><th>Vazão (Última 1h)</th><th>Vazão (24h)</th><th>Acumulado (Safra)</th>
                                </tr>
                            </thead>
                            <tbody>${flowRowsHTML}</tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="grafico-content" class="fert-sub-content">
                <div class="bg-slate-900 p-4 rounded-xl shadow-2xl h-96 lg:h-[32rem]">
                    <canvas id="lagoas-chart"></canvas>
                </div>
            </div>`;
        }

        function getLimitesTabHTML() {
            return `
            <div class="max-w-2xl mx-auto space-y-10">
                <div class="bg-white p-8 rounded-xl shadow-2xl border-t-8 border-amber-500">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Configurar Limites</h2>
                        <div class="flex items-center space-x-2">
                            <label for="equipment-select-limites" class="text-sm font-medium">Equipamento:</label>
                            <select id="equipment-select-limites" class="rounded-md border-gray-300 shadow-sm"></select>
                        </div>
                    </div>
                     <p class="text-sm text-gray-500 mb-6">Selecione um equipamento para editar seu nome e limites. O MAC Address é fixo e não pode ser alterado.</p>
                    <form id="limits-form">
                        <div class="mb-4">
                            <label for="equipment-name" class="block text-sm font-medium text-gray-700">Nome do Equipamento (ID)</label>
                            <input type="text" id="equipment-name" name="equipment-name" class="mt-1 block w-full rounded-md" required>
                        </div>
                        <div class="mb-6">
                             <label for="equipment-mac" class="block text-sm font-medium text-gray-700">MAC Address (Fixo)</label>
                            <input type="text" id="equipment-mac" class="mt-1 block w-full rounded-md bg-gray-100 cursor-not-allowed font-mono" readonly>
                        </div>
                        <fieldset class="space-y-6 mb-8 p-6 border rounded-lg"><legend class="text-lg font-semibold text-emerald-700 px-2">Limites para Status Produtivo</legend><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="input-produtivo-min" class="block text-sm font-medium text-gray-700">Prof. Mínima (cm)</label><input type="number" step="0.1" id="input-produtivo-min" name="produtivo-min" class="mt-1 block w-full rounded-md" required></div><div><label for="input-produtivo-max" class="block text-sm font-medium text-gray-700">Prof. Máxima (cm)</label><input type="number" step="0.1" id="input-produtivo-max" name="produtivo-max" class="mt-1 block w-full rounded-md" required></div></div></fieldset>
                        <fieldset class="space-y-6 mb-10 p-6 border rounded-lg"><legend class="text-lg font-semibold text-red-700 px-2">Limites para Status Manutenção</legend><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="input-parado-centro" class="block text-sm font-medium text-gray-700">h_Mesa (Centro cm)</label><input type="number" step="0.1" id="input-parado-centro" name="parado-centro" class="mt-1 block w-full rounded-md" required></div><div><label for="input-parado-tolerancia" class="block text-sm font-medium text-gray-700">Tolerância (&pm; cm)</label><input type="number" step="0.1" id="input-parado-tolerancia" name="parado-tolerancia" class="mt-1 block w-full rounded-md" required></div></div></fieldset>
                        <button type="submit" class="w-full py-3 px-4 rounded-md shadow-lg text-white bg-amber-600 hover:bg-amber-700">Salvar Alterações</button>
                    </form>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-2xl border-t-8 border-emerald-500">
                     <h2 class="text-3xl font-bold text-gray-900 mb-6">Vincular Novo Equipamento</h2>
                     <form id="new-equipment-form" class="space-y-4">
                         <div>
                             <label for="new-mac" class="block text-sm font-medium text-gray-700">MAC Address do ESP32</label>
                             <input type="text" id="new-mac" name="new-mac" placeholder="AA:BB:CC:11:22:33" class="mt-1 block w-full rounded-md font-mono" required>
                         </div>
                         <div>
                             <label for="new-equipment-name" class="block text-sm font-medium text-gray-700">Nome do Novo Equipamento (ID)</label>
                             <input type="text" id="new-equipment-name" name="new-equipment-name" placeholder="Ex: Sulcador-02" class="mt-1 block w-full rounded-md" required>
                         </div>
                         <button type="submit" class="w-full py-3 px-4 rounded-md shadow-lg text-white bg-emerald-600 hover:bg-emerald-700">Vincular Equipamento</button>
                     </form>
                </div>
            </div>`;
        }

        function getAdminHTML() {
            return `
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-2xl border-t-8 border-purple-500">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Painel de Administração</h2>
                    <div id="admin-sub-tabs" class="flex gap-2 border-b mb-6">
                        <div class="admin-sub-tab active" data-tab="pendentes">Aprovações Pendentes</div>
                        <div class="admin-sub-tab" data-tab="gerenciar">Gerenciar Usuários</div>
                        <div class="admin-sub-tab" data-tab="adicionar">Adicionar Manualmente</div>
                    </div>
                    <div id="pendentes-content" class="admin-content space-y-4">
                        <h3 class="text-xl font-semibold">Usuários aguardando aprovação</h3>
                        <div id="pendentes-list" class="space-y-3"></div>
                    </div>
                    <div id="gerenciar-content" class="admin-content hidden space-y-4">
                        <h3 class="text-xl font-semibold">Gerenciar usuários existentes</h3>
                        <div id="gerenciar-list" class="space-y-3"></div>
                    </div>
                    <div id="adicionar-content" class="admin-content hidden">
                         <form id="add-user-form" class="mb-10 p-6 border rounded-lg"><h3 class="text-lg font-semibold text-purple-700 mb-4">Adicionar Novo Usuário</h3><div class="space-y-4">
                             <input name="new-user-name" type="text" placeholder="Nome do Usuário" required class="w-full p-2 border rounded-md">
                             <input name="new-user-id" type="text" placeholder="ID do Usuário (Opcional)" class="w-full p-2 border rounded-md">
                             <input name="new-user-email" type="email" placeholder="E-mail do novo usuário" required class="w-full p-2 border rounded-md">
                             <input name="new-user-password" type="password" placeholder="Senha (mínimo 6 caracteres)" required class="w-full p-2 border rounded-md">
                             <button type="submit" class="w-full py-2 rounded-md shadow-lg text-white bg-purple-600 hover:bg-purple-700">Criar Usuário</button>
                         </div></form>
                    </div>
                </div>`;
        }

        function getManagementModalHTML(user, isApproval) {
            const title = isApproval ? 'Aprovar Usuário' : 'Gerenciar Usuário';
            const isMaster = user.role === 'Master';
            return `
            <div id="management-modal" class="modal-container fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div class="modal-content bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full relative">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">${title}</h2>
                    <p class="mb-1"><strong>Usuário:</strong> ${user.displayName}</p>
                    <p class="mb-6 text-sm text-gray-500">${user.email}</p>
                    <button id="close-management-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
                    <form id="management-form">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nível de Acesso</label>
                            <div class="flex gap-4">
                                <label><input type="radio" name="role" value="Master" ${user.role === 'Master' ? 'checked' : ''}> Master</label>
                                <label><input type="radio" name="role" value="Lider" ${user.role === 'Lider' ? 'checked' : ''}> Lider</label>
                                <label><input type="radio" name="role" value="Operação" ${user.role === 'Operação' || isApproval ? 'checked' : ''}> Operação</label>
                            </div>
                        </div>
                        <div id="permissions-div" class="${isMaster ? 'hidden' : ''} mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Permissões de Aba</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label><input type="checkbox" name="permissions" value="implementos" ${user.permissions?.includes('implementos') ? 'checked' : ''}> Implementos</label>
                                <label><input type="checkbox" name="permissions" value="fertirrigacao" ${user.permissions?.includes('fertirrigacao') ? 'checked' : ''}> Fertirrigação</label>
                                <label><input type="checkbox" name="permissions" value="limites" ${user.permissions?.includes('limites') ? 'checked' : ''}> Limites</label>
                                <label class="text-gray-500" title="Acesso ao painel de administração é exclusivo para o nível Master."><input type="checkbox" name="permissions" value="cadastro" ${user.permissions?.includes('cadastro') ? 'checked' : ''} disabled> Cadastro</label>
                            </div>
                        </div>
                        <div class="flex justify-end gap-4">
                            <button type="button" id="cancel-management" class="px-4 py-2 bg-gray-200 rounded">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>`;
        }

    </script>
</body>
</html>
